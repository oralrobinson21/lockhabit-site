<!doctype html>
<html lang="en">
<head>
  <!-- =========================================================
       LockHabit ‚Äî Demo (everything in one file, investor-ready)
       ========================================================= -->
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>LockHabit Demo ‚Äî Simulated Account + Income Calculator</title>
  <meta name="description" content="Try LockHabit‚Äôs live simulator. Lock savings, earn APR, request a self-backed loan, and see real-time projections. Start with the income calculator, send values into the demo, and watch your plan grow."/>
  <link rel="canonical" href="https://lockhabit.com/demo.html"/>
  <meta name="theme-color" content="#6f7cff"/>

  <!-- Social -->
  <meta property="og:type" content="website"/>
  <meta property="og:title" content="LockHabit Demo ‚Äî Simulated Account"/>
  <meta property="og:description" content="Build your plan, simulate interest, borrow against yourself, and see fees and net payout."/>
  <meta property="og:image" content="https://lockhabit.com/assets/og-image.svg"/>
  <meta name="twitter:card" content="summary_large_image"/>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --brand:#6f7cff; --brand2:#9c78ff; --bg:#0b0e1a; --panel:#ffffff;
      --ink:#0f172a; --ink2:#15213d; --muted:#58627a; --line:#e7e7f2;
      --green:#22c55e; --danger:#b42318; --amber:#f59e0b;
      --shadow:0 24px 60px rgba(10,15,35,.16);
      --radius:18px; --radius-lg:24px;
      --grad-hero:
        radial-gradient(1400px 700px at 50% -220px, rgba(111,124,255,.28), transparent 60%),
        radial-gradient(1000px 600px at -10% 10%, rgba(156,120,255,.18), transparent 55%),
        #f7f8ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--ink);
      font:16px/1.6 Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      overflow-x:hidden;
    }

    /* Header */
    .header{position:sticky;top:0;z-index:60;background:rgba(255,255,255,.85);
      backdrop-filter:blur(10px);border-bottom:1px solid var(--line)}
    .wrap{max-width:1200px;margin:0 auto;padding:14px 22px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:34px;height:34px}
    .word{font-weight:800}
    .btn{appearance:none;border:1px solid var(--line);background:#fff;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:800}
    .btn:hover{transform:translateY(-1px)}
    .btn.acc{background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;border:0}
    .btn.ghost{background:transparent}
    nav a{color:#14213d;text-decoration:none;margin:0 10px;font-weight:600}

    /* Hero */
    .hero{background:var(--grad-hero);border-bottom:1px solid var(--line);padding:44px 22px}
    .hero .grid{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:1.1fr .9fr;gap:24px;align-items:center}
    h1{margin:0 0 6px;font-size:40px}
    .sub{margin:0;color:#3a4a66}

    /* Bubble card (demo) */
    .bubble{margin-top:16px;background:#fff;border:1px solid var(--line);border-radius:24px;padding:20px;box-shadow:var(--shadow)}
    .balance{font-size:36px;font-weight:800;color:#0e1a34}
    .muted{color:#5b6a86}
    .pill{display:inline-flex;gap:8px;align-items:center;border:1px solid #dfe3ff;background:#f3f6ff;border-radius:999px;padding:6px 10px;font-weight:700}

    /* Bars + KPIs */
    .bar{height:10px;border-radius:999px;background:#edf0f6;overflow:hidden;border:1px solid #e5e8f1}
    .fill{height:100%;width:0;background:linear-gradient(90deg,var(--green),var(--brand));transition:width .6s ease}
    .kpi{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin-top:10px}
    .box{border:1px solid var(--line);border-radius:14px;padding:12px;background:#fbfcff}
    .k{font-size:12px;color:#5b6a86;text-transform:uppercase;letter-spacing:.04em}
    .v{font-weight:800;font-size:20px;color:#0f1a34}

    .actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:14px}
    .tag{display:inline-block;font-size:12px;border:1px solid #e7ecff;padding:4px 8px;border-radius:999px;color:#3a4a66;background:#f7f9ff}

    /* Panels */
    .section{max-width:1200px;margin:0 auto;padding:26px 22px}
    .panel{background:#fff;border:1px solid var(--line);border-radius:18px;padding:18px}
    .panel h3{margin:0 0 8px}
    .grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    .grid3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}

    input,select{padding:12px;border:1px solid #dbe0ea;border-radius:12px;font-size:16px;width:100%}
    input[type="range"]{width:100%}
    label{font-weight:700}

    .note{font-size:12px;color:#5b6a86}
    .ok{color:#0b3b22;background:#eafff2;border:1px solid #c8f5d9;border-radius:10px;padding:8px 10px;font-weight:700;display:inline-block}
    .warn{color:#5a1111;background:#ffeceb;border:1px solid #ffd4cf;border-radius:10px;padding:8px 10px;font-weight:700;display:inline-block}

    /* Modal */
    .overlay{position:fixed;inset:0;background:rgba(10,14,30,.55);backdrop-filter:blur(3px);display:none;align-items:center;justify-content:center;z-index:90}
    .modal{width:min(640px,92vw);background:#fff;border:1px solid var(--line);border-radius:16px;padding:18px;box-shadow:var(--shadow)}
    .x{border:0;background:transparent;font-size:20px;cursor:pointer;color:#64748b}

    /* Game footer (simple) */
    .miniwrap{position:fixed;left:0;right:0;bottom:0;z-index:50;padding:6px 0}
    .minibar{margin:0 auto;max-width:1200px;padding:0 10px;display:flex;gap:8px;align-items:center;justify-content:flex-end}
    .minibar .pill{display:inline-flex;align-items:center;gap:8px;background:#0e1330;color:#e5e7f1;border:1px solid #2b3150;border-radius:999px;padding:6px 10px;font-weight:700;cursor:pointer}
    #gamePanel{display:none;background:#0b0e1a;border-top:1px solid #2b3150}
    #gamePanel.open{display:block}
    #runnerCanvas{display:block;width:100%;max-width:1200px;height:120px;margin:0 auto;background:#0f172a}
    #gameInfo{max-width:1200px;margin:0 auto;color:#9fb2ff;font-size:12px;padding:6px 10px;display:flex;justify-content:space-between}

    footer{margin:22px 0;color:#cbd5e1;font-size:12px;text-align:center}

    @media (max-width:980px){ .kpi{grid-template-columns:1fr 1fr} .grid3{grid-template-columns:1fr} .grid2{grid-template-columns:1fr} .hero .grid{grid-template-columns:1fr} h1{font-size:32px} }
  </style>
</head>
<body>
  <!-- HEADER -->
  <div class="header" role="banner">
    <div class="wrap row">
      <div class="brand">
        <svg class="logo" viewBox="0 0 120 120" aria-hidden="true">
          <defs><linearGradient id="lg" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#6f7cff"/><stop offset="100%" stop-color="#9c78ff"/></linearGradient></defs>
          <rect x="12" y="22" width="96" height="80" rx="18" fill="url(#lg)"/>
          <path d="M40 50c0-16 12-28 28-28s28 12 28 28" fill="none" stroke="#ffffff" stroke-width="8" stroke-linecap="round"/>
          <path d="M40 90V58" stroke="#ffffff" stroke-width="10" stroke-linecap="round"/>
          <path d="M40 90h26" stroke="#e7ecf8" stroke-width="8" stroke-linecap="round"/>
        </svg>
        <div class="word">LockHabit</div>
      </div>
      <nav>
        <a href="#income">Income calculator</a>
        <a href="#demo">Live demo</a>
        <a href="/" class="btn ghost">‚Üê Home</a>
      </nav>
      <div class="row" style="gap:8px">
        <button class="btn" id="btnOpenGame">Mini game</button>
        <a class="btn acc" href="#demo">Try the demo</a>
      </div>
    </div>
  </div>

  <!-- HERO -->
  <div class="hero">
    <div class="grid">
      <div>
        <h1>Simulated account + calculator</h1>
        <p class="sub">Start with your income and expenses ‚Üí we‚Äôll estimate a safe amount to ‚Äúlock.‚Äù Send it into the demo and watch it grow with interest. Borrow against yourself when life happens, and see fees and net payout transparently.</p>
        <div style="margin-top:10px" class="tag">Loan eligibility uses <b>75%</b> of vested balance in this demo.</div>
      </div>
      <div class="bubble">
        <div class="row" style="align-items:flex-start">
          <div>
            <div class="muted">Total Locked Balance</div>
            <div class="balance" id="balance">$1,500.00</div>
            <div class="muted">Lock: <b id="termLabel">12 months</b> ‚Ä¢ Next deposit: <b id="nextDep">$200</b> in <b id="nextDepWhen">14 days</b></div>
            <div style="margin-top:8px" class="pill">3% APR ‚Ä¢ FDIC-backed custody*</div>
          </div>
          <div style="min-width:260px;max-width:320px;width:32%">
            <div class="muted">Progress</div>
            <div class="bar"><div class="fill" id="pbar" style="width:0%"></div></div>
            <div class="row" style="margin-top:6px"><div class="note">Year target</div><div class="note" id="pval">0%</div></div>
            <div class="grid2" style="margin-top:8px">
              <div class="box">
                <div class="k">Interest so far</div><div class="v" id="intSoFar">$0.00</div>
              </div>
              <div class="box">
                <div class="k">Projected @ maturity</div><div class="v" id="intProj">$0.00</div>
              </div>
            </div>
          </div>
        </div>
        <div class="kpi">
          <div class="box"><div class="k">Contrib so far</div><div class="v" id="contribSoFar">$0.00</div></div>
          <div class="box"><div class="k">Vested balance</div><div class="v" id="vested">$1,500.00</div></div>
          <div class="box"><div class="k">Loan eligible (75%)</div><div class="v" id="loanElig">$1,125.00</div></div>
          <div class="box"><div class="k">Unlock fee</div><div class="v" id="unlockFee">$1.00</div></div>
        </div>
        <div class="actions">
          <button class="btn acc" id="btnLoan">Request a loan</button>
          <button class="btn" id="btnEmergency">Emergency loan (0% ‚Ä¢ 1‚Äì6 mo)</button>
          <button class="btn" id="btnExtend">Extend term</button>
          <button class="btn" id="btnCashout">Cash out (simulate)</button>
          <button class="btn ghost" id="btnExplain">How this works</button>
        </div>
        <div class="note" style="margin-top:8px">* Demo only. Illustrative rates/fees. Interest for standard self-loan is credited back to your lock after payoff. Emergency loan is 0% in this demo and allows up to two skip payments per year (each skip adds 1 month).</div>
      </div>
    </div>
  </div>

  <!-- INCOME ‚Üí BUDGET ‚Üí LOCK (Calculator) -->
  <div id="income" class="section">
    <div class="panel">
      <h3>Calculate what you can safely lock</h3>
      <div class="grid3">
        <div>
          <label>Annual gross income</label>
          <input id="inc_annual" type="number" min="0" value="60000" inputmode="decimal"/>
          <div style="height:8px"></div>
          <label>Pay frequency</label>
          <select id="inc_freq">
            <option value="weekly">Weekly (52)</option>
            <option value="biweekly" selected>Bi-weekly (26)</option>
            <option value="semimonthly">Semi-monthly (24)</option>
            <option value="monthly">Monthly (12)</option>
          </select>
          <div style="height:8px"></div>
          <label>State (for tax estimate)</label>
          <select id="inc_state">
            <!-- Simple illustrative list with rough effective adders -->
            <option value="0">No state tax (e.g., FL, TX)</option>
            <option value="3">~3% effective</option>
            <option value="5">~5% effective</option>
            <option value="7">~7% effective</option>
            <option value="9">~9% effective</option>
          </select>
          <div style="height:8px"></div>
          <label class="row" style="gap:8px;align-items:center">
            <input id="tax_exempt" type="checkbox" style="width:auto"/> Assume tax-exempt (demo)
          </label>
          <div class="note">This calculator is an <b>estimate</b>, not tax advice. For simplicity, we apply rough effective federal + FICA + selected state %.</div>
        </div>
        <div>
          <label>Estimated monthly expenses (rent, utilities, etc.)</label>
          <input id="exp_monthly" type="number" min="0" value="2500"/>
          <div style="height:8px"></div>
          <label>Safety buffer (%)</label>
          <input id="buffer_pct" type="range" min="0" max="30" value="10"/>
          <div class="row"><div class="note">0%</div><div class="note" id="buffer_lbl">10%</div></div>
          <div style="height:8px"></div>
          <div class="box">
            <div class="k">Estimated take-home / month</div>
            <div class="v" id="takehome">$0.00</div>
          </div>
          <div class="box" style="margin-top:8px">
            <div class="k">Safe to lock / month</div>
            <div class="v" id="safe_month">$0.00</div>
          </div>
        </div>
        <div>
          <label>Lock frequency you prefer</label>
          <select id="lock_freq">
            <option value="weekly">Weekly</option>
            <option value="biweekly" selected>Bi-weekly</option>
            <option value="monthly">Monthly</option>
          </select>
          <div style="height:8px"></div>
          <div class="box">
            <div class="k">Converted per-deposit amount</div>
            <div class="v" id="per_deposit">$0.00</div>
          </div>
          <div class="box" style="margin-top:8px">
            <div class="k">Starter deposit (optional)</div>
            <input id="starter" type="number" min="0" value="1500"/>
          </div>
          <div class="actions" style="margin-top:10px">
            <button class="btn acc" id="sendToDemo">Send to demo</button>
            <button class="btn" id="recalcBtn">Update snapshot</button>
          </div>
          <div class="note">Sending to demo stores values in your browser (localStorage) and updates the simulator instantly.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- LEGAL NOTE -->
  <div class="section">
    <div class="panel">
      <h3>Transparency & fine print (demo)</h3>
      <ul>
        <li>Standard self-loan: <b>6% APR</b>, interest is <b>credited back</b> to your lock after payoff (credit-builder intent).</li>
        <li>Emergency loan: up to <b>90%</b> of vested, <b>0% APR</b>, term <b>1‚Äì6 months</b>, up to <b>two skip payments per calendar year</b> (each skip extends term by 1 month).</li>
        <li>Unlock fee at maturity: <b>$3 / $2 / $1</b> for 1‚Äì3 / 4‚Äì6 / 6‚Äì12+ month locks.</li>
        <li><b>Early break</b> (non-emergency) incurs a demo fee of <b>7%</b> of vested balance.</li>
        <li>All figures shown here are <b>estimates</b> for education; final terms may change at launch.</li>
      </ul>
    </div>
  </div>

  <!-- FOOTER -->
  <footer>¬© <span id="yr"></span> LockHabit ‚Äî Demo simulation.</footer>

  <!-- GAME (simple) -->
  <div class="miniwrap">
    <div class="minibar">
      <button id="toggleGame" class="pill" aria-expanded="false" aria-controls="gamePanel">üéÆ Mini game (off)</button>
    </div>
    <div id="gamePanel" role="region" aria-label="Endless runner mini game">
      <canvas id="runnerCanvas" width="1200" height="120"></canvas>
      <div id="gameInfo"><span>Space/‚Üë jump ‚Ä¢ R reset ‚Ä¢ P pause</span><span id="gameScore">Score: 0</span></div>
    </div>
  </div>

  <!-- MODAL -->
  <div id="overlay" class="overlay" aria-modal="true" role="dialog">
    <div class="modal" id="modalBox" role="document">
      <div class="row">
        <h3 id="modalTitle" style="margin:0">Modal</h3>
        <button class="x" id="modalClose">‚úï</button>
      </div>
      <div id="modalBody" style="margin-top:8px"></div>
    </div>
  </div>

  <script>
    // ========= Helpers =========
    const $ = (id)=> document.getElementById(id);
    const fmt = (n)=> Number(n||0).toLocaleString(undefined,{style:'currency',currency:'USD'});
    const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
    const monthsToFee = (m)=> m<=3?3 : m<=6?2 : 1;

    // ========= Demo State (defaults; can be overridden by calculator) =========
    let principal = 1500;           // starter deposit
    let termMonths = 12;            // default term
    let aprSave = 0.03;             // safe APR
    let recAmount = 200;            // recurring deposit
    let recFreq = 'biweekly';       // weekly | biweekly | monthly
    let progress = 0;               // 0..100 simulated progress
    let skipCredits = 2;            // emergency loan skip payments per calendar year (demo)

    // ========= DOM refs for demo header bubble =========
    const balEl = $('balance');
    const termLabel = $('termLabel');
    const nextDep = $('nextDep');          // amount
    const nextDepWhen = $('nextDepWhen');  // when text
    const pbar = $('pbar'), pval = $('pval');
    const intSoFar = $('intSoFar'), intProj = $('intProj');
    const contribSoFar = $('contribSoFar');
    const vestedEl = $('vested'), loanElig = $('loanElig');
    const unlockFee = $('unlockFee');

    $('yr').textContent = new Date().getFullYear();

    // ========= Recurrence helpers =========
    function cyclesFor(freq, months){
      const weeks = months * 4.345;
      if(freq==='weekly') return Math.floor(weeks);
      if(freq==='biweekly') return Math.floor(weeks/2);
      return months; // monthly
    }
    function nextDepositWhen(freq){
      if(freq==='weekly') return '7 days';
      if(freq==='biweekly') return '14 days';
      return '30 days';
    }

    // ========= Vesting math (demo simple) =========
    function calcProjections(){
      // contributions to date scale with progress %
      const totalCycles = cyclesFor(recFreq, termMonths);
      const contributedFullTerm = recAmount * totalCycles;
      const contributedSoFarVal = contributedFullTerm * (progress/100);

      const vested = principal + contributedSoFarVal;

      const interestFullTerm = (principal + contributedFullTerm) * aprSave * (termMonths/12);
      const interestSoFarVal = interestFullTerm * (progress/100);

      const elig = vested * 0.75; // 75% of vested

      // write
      balEl.textContent = fmt(principal);
      termLabel.textContent = termMonths + ' months';
      nextDep.textContent = fmt(recAmount);
      nextDepWhen.textContent = nextDepositWhen(recFreq);
      contribSoFar.textContent = fmt(contributedSoFarVal);
      vestedEl.textContent = fmt(vested);
      intProj.textContent = fmt(interestFullTerm);
      intSoFar.textContent = fmt(interestSoFarVal);
      loanElig.textContent = fmt(elig);
      unlockFee.textContent = fmt(monthsToFee(termMonths));
    }

    // simulate progress animation
    setInterval(()=>{
      progress = (progress + Math.random()*4) % 100;
      pbar.style.width = progress.toFixed(0)+'%';
      pval.textContent = progress.toFixed(0)+'%';
      calcProjections();
    }, 900);

    // ========= Explain modal =========
    $('btnExplain').addEventListener('click', ()=>{
      openModal('How the demo works', `
        <p>‚Ä¢ Your plan starts with a starter deposit and recurring contributions (weekly/bi-weekly/monthly).<br/>
        ‚Ä¢ Interest accrues at a transparent <b>${(aprSave*100).toFixed(1)}% APR</b> (prorated).<br/>
        ‚Ä¢ <b>Loan eligibility</b> uses <b>75%</b> of your vested balance (starter + contributions so far).<br/>
        ‚Ä¢ <b>Standard self-loan:</b> 6% APR, interest is credited back to your lock after payoff (credit-builder intent).<br/>
        ‚Ä¢ <b>Emergency loan:</b> up to 90% of vested, 0% APR for 1‚Äì6 months, up to two skip payments per year (each skip extends term 1 month).<br/>
        ‚Ä¢ <b>Unlock fee:</b> $3 / $2 / $1 for 1‚Äì3 / 4‚Äì6 / 6‚Äì12+ month locks.<br/>
        ‚Ä¢ <b>Early break (non-emergency):</b> demo fee 7% of vested.</p>
        <div class="note">All values are estimates for illustration only.</div>
      `);
    });

    // ========= Extend term =========
    $('btnExtend').addEventListener('click', ()=>{
      openModal('Extend term', `
        <p>Extend your lock to keep earning ${(aprSave*100).toFixed(1)}% APR. New unlock fee applies at the new maturity.</p>
        <div class="grid2">
          <div>
            <label>Add months</label>
            <select id="extendSel">
              <option value="3">+3 months</option>
              <option value="6" selected>+6 months</option>
              <option value="12">+12 months</option>
            </select>
          </div>
          <div>
            <label>New unlock fee</label>
            <div class="v" id="newFee">${fmt(monthsToFee(termMonths+6))}</div>
          </div>
        </div>
        <div class="actions" style="margin-top:12px">
          <button class="btn acc" id="doExtend">Confirm extend</button>
          <button class="btn" onclick="closeModal()">Cancel</button>
        </div>
        <div class="note">In production, higher tiers could offer higher APR after upgrade effective next cycle.</div>
      `);
      const sel = $('extendSel'), feeEl = $('newFee');
      sel.addEventListener('change', ()=> feeEl.textContent = fmt(monthsToFee(termMonths+Number(sel.value))));
      $('doExtend').addEventListener('click', ()=>{
        termMonths += Number(sel.value);
        calcProjections();
        closeModal();
        setTimeout(()=>openModal('Extended', `<div class="ok">‚úÖ Term extended to <b>${termMonths} months</b>.</div>`), 60);
      });
    });

    // ========= Standard loan (6% credited back) =========
    $('btnLoan').addEventListener('click', ()=>{
      // compute current vested and eligible
      const totalCycles = cyclesFor(recFreq, termMonths);
      const vested = principal + (recAmount * totalCycles * (progress/100));
      const maxElig = Math.floor(vested * 0.75);
      const def = clamp( Math.min(500, maxElig), 100, maxElig);

      openModal('Request a self-backed loan', `
        <p>Borrow against yourself at <b>6% APR</b>. Interest you pay is <b>credited back</b> to your locked balance after payoff.</p>
        <label>Loan amount: <span id="loanAmtVal">${fmt(def)}</span></label>
        <input id="loanAmt" type="range" min="100" max="${Math.max(100,maxElig)}" step="50" value="${def}"/>
        <div class="grid2" style="margin-top:8px">
          <div>
            <label>Repayment term</label>
            <select id="loanTerm">
              <option value="3" selected>3 months</option>
              <option value="6">6 months</option>
              <option value="12">12 months</option>
            </select>
          </div>
          <div>
            <label>Monthly payment</label>
            <div class="v" id="loanPmt">$0.00</div>
          </div>
        </div>
        <div class="grid2" style="margin-top:8px">
          <div class="box"><div class="k">Total repay</div><div class="v" id="loanTotal">$0.00</div></div>
          <div class="box"><div class="k">Interest (back to you)</div><div class="v" id="loanIntBack">$0.00</div></div>
        </div>
        <div class="note" style="margin-top:8px">On-time payments may help credit; late payments may harm it (credit-builder intent).</div>
        <div class="actions" style="margin-top:12px">
          <button class="btn acc" id="doLoan">Request loan</button>
          <button class="btn" onclick="closeModal()">Cancel</button>
        </div>
      `);

      const aprLoan = 0.06;
      const amt = $('loanAmt'), amtVal = $('loanAmtVal');
      const termSel = $('loanTerm'), pmtEl = $('loanPmt'), totalEl = $('loanTotal'), intBackEl = $('loanIntBack');

      function recalc(){
        const A = Number(amt.value), m = Number(termSel.value);
        amtVal.textContent = fmt(A);
        const interest = A * aprLoan * (m/12); // simple interest for demo
        const total = A + interest;
        pmtEl.textContent = fmt(total/m);
        totalEl.textContent = fmt(total);
        intBackEl.textContent = fmt(interest);
      }
      amt.addEventListener('input', recalc);
      termSel.addEventListener('change', recalc);
      recalc();

      $('doLoan').addEventListener('click', ()=>{
        closeModal();
        setTimeout(()=>openModal('Loan simulated', `
          <div class="ok">‚úÖ Funds released to you (demo).</div>
          <p>Your monthly payment is shown above. All interest is credited back to your lock after payoff.</p>
        `), 120);
      });
    });

    // ========= Emergency loan (0% APR, 1‚Äì6 months, up to 90%, 2 skip credits) =========
    $('btnEmergency').addEventListener('click', ()=>{
      const totalCycles = cyclesFor(recFreq, termMonths);
      const vested = principal + (recAmount * totalCycles * (progress/100));
      const maxElig = Math.floor(vested * 0.90);
      const def = clamp(Math.min(600, maxElig), 100, maxElig);

      openModal('Emergency loan (0% APR)', `
        <p>Access up to <b>90%</b> of your vested balance at <b>0% APR</b> for <b>1‚Äì6 months</b>. Up to <b>two</b> skip payments per calendar year (each skip adds 1 month).</p>
        <label>Loan amount: <span id="eAmtVal">${fmt(def)}</span></label>
        <input id="eAmt" type="range" min="100" max="${Math.max(100,maxElig)}" step="50" value="${def}"/>
        <div class="grid2" style="margin-top:8px">
          <div>
            <label>Term (months)</label>
            <select id="eTerm">
              <option value="1">1</option><option value="2">2</option><option value="3" selected>3</option>
              <option value="4">4</option><option value="5">5</option><option value="6">6</option>
            </select>
          </div>
          <div>
            <label>Monthly payment</label>
            <div class="v" id="ePmt">$0.00</div>
          </div>
        </div>
        <div class="box" style="margin-top:8px">
          <div class="k">Skip-payment credits available</div>
          <div class="v" id="skipLeft">${skipCredits}</div>
        </div>
        <div class="actions" style="margin-top:12px">
          <button class="btn acc" id="doEmerg">Request emergency loan</button>
          <button class="btn" id="useSkip">Use 1 skip now</button>
          <button class="btn" onclick="closeModal()">Cancel</button>
        </div>
        <div class="note">Each skip extends your term by 1 month. Demo only.</div>
      `);

      const eAmt=$('eAmt'), eAmtVal=$('eAmtVal'), eTerm=$('eTerm'), ePmt=$('ePmt'), skipLeft=$('skipLeft');

      function recalcE(){
        const A=Number(eAmt.value), m=Number(eTerm.value);
        eAmtVal.textContent = fmt(A);
        ePmt.textContent = fmt(A/m); // 0% simple divide
      }
      eAmt.addEventListener('input', recalcE);
      eTerm.addEventListener('change', recalcE);
      recalcE();

      $('useSkip').addEventListener('click', ()=>{
        if(skipCredits<=0){ alert('No skip credits left this year.'); return; }
        skipCredits -= 1;
        eTerm.value = String(Number(eTerm.value)+1);
        recalcE();
        skipLeft.textContent = skipCredits;
      });
      $('doEmerg').addEventListener('click', ()=>{
        closeModal();
        setTimeout(()=>openModal('Emergency loan simulated', `
          <div class="ok">‚úÖ 0% emergency funds released (demo).</div>
          <p>Repay over the selected term. Skips used: <b>${2-skipCredits}</b>. Remaining this year: <b>${skipCredits}</b>.</p>
        `), 120);
      });
    });

    // ========= Cash out (with early break option) =========
    $('btnCashout').addEventListener('click', ()=>{
      const totalCycles = cyclesFor(recFreq, termMonths);
      const contribFull = recAmount * totalCycles;
      const interestFull = (principal + contribFull) * aprSave * (termMonths/12);
      const fee = monthsToFee(termMonths);
      const gross = principal + interestFull;
      const net = gross - fee;

      openModal('Cash out (simulation)', `
        <div class="grid2">
          <div class="box"><div class="k">Principal</div><div class="v">${fmt(principal)}</div></div>
          <div class="box"><div class="k">Interest (projected @ maturity)</div><div class="v">${fmt(interestFull)}</div></div>
          <div class="box"><div class="k">Unlock fee</div><div class="v">-${fmt(fee)}</div></div>
          <div class="box"><div class="k">Net to you (at maturity)</div><div class="v">${fmt(net)}</div></div>
        </div>
        <div class="actions" style="margin-top:12px">
          <button class="btn acc" id="doRelock">Relock for +12 months</button>
          <button class="btn" id="breakEarly">Break early (7% fee)</button>
          <button class="btn" onclick="closeModal()">Close</button>
        </div>
        <div class="note">Breaking early is discouraged; consider a self-loan or emergency loan first.</div>
      `);
      $('doRelock').addEventListener('click', ()=>{
        termMonths = 12; progress = 0; calcProjections(); closeModal();
        setTimeout(()=>openModal('Relocked', `<div class="ok">‚úÖ Balance relocked for another 12 months.</div>`), 80);
      });
      $('breakEarly').addEventListener('click', ()=>{
        const totalCyclesNow = cyclesFor(recFreq, termMonths);
        const contributedSoFar = recAmount * totalCyclesNow * (progress/100);
        const vested = principal + contributedSoFar;
        const penalty = vested * 0.07;
        closeModal();
        setTimeout(()=>openModal('Early break (simulation)', `
          <div class="warn">‚ö†Ô∏è Early break incurs a 7% fee on vested.</div>
          <div class="grid2" style="margin-top:8px">
            <div class="box"><div class="k">Vested right now</div><div class="v">${fmt(vested)}</div></div>
            <div class="box"><div class="k">Penalty (7%)</div><div class="v">-${fmt(penalty)}</div></div>
          </div>
          <p>In production, we‚Äôd confirm your destination account and show final net payout.</p>
        `), 100);
      });
    });

    // ========= Modal plumbing =========
    const overlay = $('overlay'), modalBox = $('modalBox'), modalTitle = $('modalTitle'), modalBody = $('modalBody');
    function openModal(title, html){
      modalTitle.textContent = title;
      modalBody.innerHTML = html;
      overlay.style.display = 'flex';
      document.body.style.overflow='hidden';
    }
    function closeModal(){
      overlay.style.display='none';
      document.body.style.overflow='';
    }
    $('modalClose').addEventListener('click', closeModal);
    overlay.addEventListener('click', (e)=>{ if(e.target===overlay) closeModal(); });

    // ========= Income ‚Üí Budget ‚Üí Lock calculator =========
    const inc_annual=$('inc_annual'), inc_freq=$('inc_freq'), inc_state=$('inc_state'), tax_exempt=$('tax_exempt');
    const exp_monthly=$('exp_monthly'), buffer_pct=$('buffer_pct'), buffer_lbl=$('buffer_lbl');
    const takehome=$('takehome'), safe_month=$('safe_month'), lock_freq=$('lock_freq'), per_deposit=$('per_deposit'), starter=$('starter');
    buffer_lbl.textContent = buffer_pct.value + '%';

    function estimateTakeHome(annual, stateEffPct, exempt){
      if(exempt) return annual; // demo mode
      // Rough effective rates: federal ~12% effective at 60k + FICA ~7.65% + state
      const fedEff = clamp(annual<=40000?0.08 : annual<=85000?0.12 : annual<=160000?0.16 : 0.20, 0, 0.4);
      const fica = 0.0765;
      const state = (stateEffPct||0)/100;
      const eff = fedEff + fica + state;
      return annual * (1 - eff);
    }
    function recalcIncome(){
      buffer_lbl.textContent = buffer_pct.value + '%';
      const annual = Number(inc_annual.value||0);
      const statePct = Number(inc_state.value||0);
      const th = estimateTakeHome(annual, statePct, tax_exempt.checked);
      takehome.textContent = fmt(th/12);
      const safe = Math.max(0, (th/12) - Number(exp_monthly.value||0));
      const safeBuf = Math.max(0, safe * (1 - Number(buffer_pct.value)/100));
      safe_month.textContent = fmt(safeBuf);

      // convert to chosen lock frequency
      let per=0;
      if(lock_freq.value==='weekly') per = safeBuf/4.345;
      else if(lock_freq.value==='biweekly') per = safeBuf/2.1725;
      else per = safeBuf; // monthly
      per_deposit.textContent = fmt(per);
      return { perDeposit: per, starter: Number(starter.value||0) };
    }
    [inc_annual,inc_freq,inc_state,tax_exempt,exp_monthly,buffer_pct,lock_freq,starter].forEach(el=> el.addEventListener('input', recalcIncome));
    $('recalcBtn').addEventListener('click', recalcIncome);
    recalcIncome();

    // handoff to demo
    $('sendToDemo').addEventListener('click', ()=>{
      const { perDeposit, starter: st } = recalcIncome();
      // Save to localStorage + apply immediately
      try{
        localStorage.setItem('lh_rec_amount', String(Math.max(0, Math.round(perDeposit))));
        localStorage.setItem('lh_rec_freq', lock_freq.value);
        localStorage.setItem('lh_starter', String(Math.max(0, Math.round(st))));
      }catch(_){}
      // apply to current session
      recAmount = Math.max(0, Math.round(perDeposit));
      recFreq = lock_freq.value;
      principal = Math.max(0, Math.round(st));
      progress = 0; // restart the ‚Äúyear‚Äù
      calcProjections();
      // scroll to demo
      location.hash = '#demo';
      openModal('Snapshot sent', `<div class="ok">‚úÖ Your amounts were applied to the demo.</div>`);
    });

    // ========= Load values from query params or localStorage =========
    (function bootFromStorage(){
      const p = new URLSearchParams(location.search);
      const qs = (k)=> p.get(k);
      const ls = (k)=> { try{ return localStorage.getItem(k) }catch(_){ return null } };

      const ra = Number(qs('rec') || ls('lh_rec_amount') || recAmount);
      const rf = qs('freq') || ls('lh_rec_freq') || recFreq;
      const st = Number(qs('init') || ls('lh_starter') || principal);

      if(!isNaN(ra)) recAmount = ra;
      if(rf) recFreq = rf;
      if(!isNaN(st)) principal = st;

      $('nextDep').textContent = fmt(recAmount);
      $('nextDepWhen').textContent = nextDepositWhen(recFreq);
      $('balance').textContent = fmt(principal);
      calcProjections();
    })();

    // ========= Mini runner (lightweight) =========
    (function(){
      const toggleBtn = $('toggleGame'), panel=$('gamePanel'), cvs=$('runnerCanvas'), scoreEl=$('gameScore');
      const ctx = cvs.getContext('2d'); let W=cvs.width, H=cvs.height;
      let running=false, paused=false, t0=0, score=0, raf;
      const G=0.9, ground=H-18; const player={x:40,y:ground,vy:0,w:14,h:14,onGround:true};
      let obs=[], spawn=0;
      function reset(){ score=0; obs=[]; spawn=0; player.y=ground; player.vy=0; player.onGround=true; paused=false; }
      function jump(){ if(!running||paused) return; if(player.onGround){ player.vy=-12; player.onGround=false; } }
      function drawBg(){ ctx.fillStyle='#0f172a'; ctx.fillRect(0,0,W,H); ctx.strokeStyle='#26304a'; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(0,ground+8); ctx.lineTo(W,ground+8); ctx.stroke(); }
      function drawPlayer(){ ctx.fillStyle='#e6eaff'; ctx.fillRect(player.x, player.y-player.h, player.w, player.h); }
      function addObstacle(){ const h=10+Math.floor(Math.random()*18); const w=8+Math.floor(Math.random()*10); const v=4+Math.random()*2; obs.push({x:W+10,y:ground,w,h,v}); }
      function drawObs(){ ctx.fillStyle='#91a1ff'; for(const o of obs){ ctx.fillRect(o.x, o.y-o.h, o.w, o.h); } }
      function collide(a,b){ return !(a.x+a.w<b.x || a.x>b.x+b.w || a.y<b.y-b.h || a.y-a.h>b.y); }
      function resize(){ const dpr=Math.max(1,Math.min(2,window.devicePixelRatio||1)); const cssW=Math.min(1200,document.documentElement.clientWidth); cvs.style.width=cssW+'px'; cvs.width=cssW*dpr; cvs.height=120*dpr; ctx.setTransform(dpr,0,0,dpr,0,0); W=cssW; }
      window.addEventListener('resize', resize,{passive:true}); resize();
      function step(ts){
        if(!running) return;
        if(paused){ raf=requestAnimationFrame(step); return; }
        if(!t0) t0=ts; const dt=Math.min(32, ts-t0); t0=ts;
        player.vy+=G; player.y+=player.vy; if(player.y>=ground){ player.y=ground; player.vy=0; player.onGround=true; }
        spawn-=dt; if(spawn<=0){ addObstacle(); spawn=800+Math.random()*900; }
        for(const o of obs) o.x-=o.v; obs=obs.filter(o=>o.x+o.w>-10);
        for(const o of obs){ if(collide({x:player.x,y:player.y,w:player.w,h:player.h},{x:o.x,y:o.y,w:o.w,h:o.h})){ ctx.save(); ctx.fillStyle='rgba(255,0,70,.18)'; ctx.fillRect(0,0,W,H); ctx.restore(); reset(); break; } }
        score+=Math.floor(dt/10); scoreEl.textContent='Score: '+score;
        drawBg(); drawObs(); drawPlayer();
        raf=requestAnimationFrame(step);
      }
      function start(){ if(running) return; running=true; paused=false; t0=0; raf=requestAnimationFrame(step); }
      function stop(){ running=false; paused=false; cancelAnimationFrame(raf); }
      toggleBtn.addEventListener('click', ()=>{
        const open=panel.classList.toggle('open');
        toggleBtn.textContent=open?'üéÆ Mini game (on)':'üéÆ Mini game (off)';
        if(open) start(); else stop();
      });
      $('btnOpenGame').addEventListener('click', ()=> toggleBtn.click());
      window.addEventListener('keydown', (e)=>{ if(panel.classList.contains('open')){ if(e.code==='Space'||e.code==='ArrowUp'){e.preventDefault(); jump();} if(e.code==='KeyR') reset(); if(e.code==='KeyP') paused=!paused; }});
      cvs.addEventListener('touchstart', (e)=>{ if(panel.classList.contains('open')){ e.preventDefault(); jump(); } }, {passive:false});
    })();
  </script>
</body>
</html>