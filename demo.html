<!doctype html>
<html lang="en">
<head>
  <!-- =========================================================
       LockHabit — Live Demo (calculator → simulator flow)
       - SEO optimized
       - Calculator: weekly/bi-weekly/monthly + state taxes + tax-exempt
       - Simulator: progress, vested interest, 75% loan eligibility
       ========================================================= -->

  <!-- Core -->
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>

  <title>LockHabit Demo — Income Calculator & Savings Simulator</title>
  <meta name="description" content="Try LockHabit's free income calculator and savings simulator. Estimate your take-home pay weekly, bi-weekly, or monthly (with federal & state taxes), then see how much you can safely 'lock' and grow with interest. Request self-backed loans (75% of vested balance) in the demo."/>
  <meta name="theme-color" content="#6f7cff"/>

  <!-- Canonical -->
  <link rel="canonical" href="https://lockhabit.com/demo.html"/>

  <!-- Social -->
  <meta property="og:type" content="website"/>
  <meta property="og:title" content="LockHabit Demo — Income Calculator & Savings Simulator"/>
  <meta property="og:description" content="Estimate take-home pay and simulate disciplined saving with interest. Borrow against your own balance when needed."/>
  <meta property="og:url" content="https://lockhabit.com/demo.html"/>
  <meta property="og:image" content="https://lockhabit.com/assets/og-image.svg"/>
  <meta name="twitter:card" content="summary_large_image"/>
  <meta name="twitter:title" content="LockHabit Demo — Income Calculator & Savings Simulator"/>
  <meta name="twitter:description" content="Estimate take-home pay and simulate disciplined saving."/>
  <meta name="twitter:image" content="https://lockhabit.com/assets/og-image.svg"/>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>

  <!-- Icons / PWA (optional) -->
  <link rel="icon" href="/assets/favicon.svg" type="image/svg+xml">
  <link rel="alternate icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/assets/icon-192.png">
  <link rel="manifest" href="/manifest.webmanifest">

  <!-- Styles -->
  <style>
    :root{
      --brand:#6f7cff; --brand2:#9c78ff; --bg:#0b0e1a; --panel:#ffffff;
      --ink:#0f172a; --muted:#5b6a86; --muted2:#3a4a66; --line:#e5e7f1; --line2:#dfe3ff;
      --green:#22c55e; --danger:#b42318; --amber:#f59e0b;
      --shadow:0 24px 60px rgba(10,15,35,.18);
      --shadow2:0 40px 120px rgba(7,10,18,.28);
      --radius:18px; --radius-lg:24px; --radius-xl:28px;
      --grad-hero:
        radial-gradient(1400px 800px at 50% -240px, rgba(111,124,255,.35), transparent 60%),
        radial-gradient(1000px 600px at -12% 0%, rgba(156,120,255,.18), transparent 55%),
        radial-gradient(1200px 700px at 110% -20%, rgba(183,168,255,.12), transparent 60%),
        #f7f9ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--ink);
      font:16px/1.6 Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
      overflow-x:hidden;
    }

    /* Header */
    .header{position:sticky;top:0;z-index:60;background:rgba(255,255,255,.88);backdrop-filter:blur(10px);border-bottom:1px solid var(--line);transition:transform .25s ease}
    .header.hide{transform:translateY(-100%)}
    .wrap{max-width:1200px;margin:0 auto;padding:12px 22px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:34px;height:34px}
    .word{font-weight:800;letter-spacing:.2px}
    .nav{display:flex;align-items:center;gap:10px}
    .nav a{color:#19253f;text-decoration:none;font-weight:600}
    .btn{appearance:none;border:1px solid var(--line);background:#fff;padding:10px 14px;border-radius:12px;font-weight:800;cursor:pointer;min-height:42px;transition:.15s}
    .btn:hover{transform:translateY(-1px)}
    .btn.acc{background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;border:0}
    .btn.ghost{background:transparent}

    /* Hero */
    .hero{background:var(--grad-hero);border-bottom:1px solid var(--line);padding:60px 22px 30px}
    .hero h1{margin:0 0 6px;font-size:40px}
    .sub{color:var(--muted2);margin:0}

    /* Sandwich: Calculator (center) with Snapshot on side (mobile stacks) */
    .grid{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:1.1fr .9fr;gap:18px;align-items:start}
    .card{background:#fff;border:1px solid var(--line);border-radius:22px;padding:18px;box-shadow:var(--shadow)}
    .card h3{margin:0 0 10px}
    .k{font-size:12px;color:#5b6a86;text-transform:uppercase;letter-spacing:.04em}
    .v{font-weight:800;font-size:20px;color:#0e1a34}
    .rowx{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    .muted{color:var(--muted)}
    input, select{width:100%;padding:12px;border:1px solid #dbe0ea;border-radius:12px;font-size:16px}
    input[type="range"]{padding:0}
    .pill{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--line2);background:#f3f6ff;border-radius:999px;padding:6px 10px;font-weight:700}
    .note{font-size:12px;color:#60708c}
    .ok{color:#0b3b22;background:#eafff2;border:1px solid #c8f5d9;border-radius:10px;padding:8px 10px;font-weight:700;display:inline-block}
    .warn{color:#5a1111;background:#ffeceb;border:1px solid #ffd4cf;border-radius:10px;padding:8px 10px;font-weight:700;display:inline-block}

    /* Snapshot column */
    .snapshot .balance{font-size:36px;font-weight:800;color:#0f1a34}
    .bar{height:10px;border-radius:999px;background:#edf0f6;overflow:hidden;border:1px solid #e5e8f1}
    .fill{height:100%;width:0;background:linear-gradient(90deg,var(--green),var(--brand));transition:width .6s ease}

    /* Simulator bubble */
    .bubble{border-radius:26px;background:#fff;border:1px solid var(--line);box-shadow:var(--shadow2);padding:22px;margin-top:18px}
    .balance-lg{font-size:40px;font-weight:800;color:#0e1a34}
    .kpi{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
    .kpi .box{background:#fbfcff;border:1px solid var(--line);border-radius:14px;padding:12px}
    .actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}

    /* Modal */
    .overlay{position:fixed;inset:0;background:rgba(10,14,30,.55);backdrop-filter:blur(3px);display:none;align-items:center;justify-content:center;z-index:90}
    .modal{width:min(620px,92vw);background:#fff;border:1px solid var(--line);border-radius:16px;padding:18px;box-shadow:var(--shadow2)}
    .x{border:0;background:transparent;font-size:20px;cursor:pointer;color:#64748b}

    /* Footer */
    footer{margin:24px 0;color:#cbd5e1;font-size:12px;text-align:center}

    /* Responsive */
    @media (max-width:1000px){
      .grid{grid-template-columns:1fr}
      .kpi{grid-template-columns:1fr 1fr}
    }
    @media (max-width:560px){
      .kpi{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header id="hdr" class="header">
    <div class="wrap">
      <div class="row">
        <div class="brand">
          <svg class="logo" viewBox="0 0 120 120" aria-hidden="true">
            <defs><linearGradient id="lg" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#6f7cff"/><stop offset="100%" stop-color="#9c78ff"/></linearGradient></defs>
            <rect x="12" y="22" width="96" height="80" rx="18" fill="url(#lg)"/>
            <path d="M40 50c0-16 12-28 28-28s28 12 28 28" fill="none" stroke="#ffffff" stroke-width="8" stroke-linecap="round"/>
            <path d="M40 90V58" stroke="#ffffff" stroke-width="10" stroke-linecap="round"/>
            <path d="M40 90h26" stroke="#e7ecf8" stroke-width="8" stroke-linecap="round"/>
          </svg>
          <div class="word">LockHabit</div>
        </div>
        <nav class="nav">
          <a href="/">Home</a>
          <a href="#calculator">Calculator</a>
          <a href="#simulator">Simulator</a>
          <button class="btn acc" onclick="openWaitlist()">Join waitlist</button>
        </nav>
      </div>
    </div>
  </header>

  <!-- Hero -->
  <section class="hero">
    <div class="wrap">
      <h1>Calculate your take-home & simulate disciplined saving</h1>
      <p class="sub">Pick weekly, bi-weekly, or monthly income. Estimate taxes, choose how much to “lock,” then see your projected growth and loan access (75% of vested balance).</p>
    </div>
  </section>

  <!-- Sandwich: Calculator (center) + Snapshot (side) -->
  <section id="calculator" class="wrap" aria-labelledby="calc-title" style="padding:18px 22px">
    <div class="grid">
      <!-- Calculator -->
      <div class="card" id="calcCard" role="region" aria-label="Income calculator">
        <h3 id="calc-title">Income Calculator</h3>
        <div class="rowx">
          <div>
            <label class="k">Income frequency</label>
            <select id="inc_freq">
              <option value="weekly">Weekly</option>
              <option value="biweekly" selected>Bi-weekly</option>
              <option value="monthly">Monthly</option>
              <option value="annual">Annual</option>
            </select>
          </div>
          <div>
            <label class="k">Amount (gross)</label>
            <input id="inc_amt" type="number" min="0" step="0.01" value="2000" placeholder="e.g., 2000"/>
          </div>
        </div>

        <div class="rowx" style="margin-top:10px">
          <div>
            <label class="k">Filing status</label>
            <select id="filing">
              <option value="single" selected>Single (est.)</option>
              <option value="married">Married (est.)</option>
            </select>
          </div>
          <div>
            <label class="k">State (estimate)</label>
            <select id="state">
              <option value="none" selected>— Select —</option>
              <option value="CA">California</option>
              <option value="NY">New York</option>
              <option value="TX">Texas</option>
              <option value="FL">Florida</option>
              <option value="IL">Illinois</option>
              <option value="PA">Pennsylvania</option>
              <option value="OH">Ohio</option>
              <option value="MI">Michigan</option>
              <option value="GA">Georgia</option>
              <option value="NC">North Carolina</option>
            </select>
          </div>
        </div>

        <div class="rowx" style="margin-top:10px">
          <div>
            <label class="k">Tax status</label>
            <select id="taxopt">
              <option value="normal" selected>Normal withholding</option>
              <option value="exempt">Temporarily tax-exempt</option>
            </select>
          </div>
          <div>
            <label class="k">Monthly expenses (estimate)</label>
            <input id="expenses" type="number" min="0" step="0.01" value="1500" placeholder="e.g., 1500"/>
          </div>
        </div>

        <div style="margin-top:10px">
          <label class="k">Suggested “lock” % of take-home</label>
          <input id="save_pct" type="range" min="5" max="25" value="15" step="1"/>
          <div class="row" style="justify-content:space-between">
            <span class="muted">Conservative</span>
            <span class="pill"><b id="save_pct_lbl">15%</b></span>
            <span class="muted">Ambitious</span>
          </div>
        </div>

        <div class="rowx" style="margin-top:12px">
          <div class="card" style="padding:12px">
            <div class="k">Estimated take-home / period</div>
            <div class="v" id="takehome">$0.00</div>
            <div class="note">Rough estimate: federal + FICA + simple state rate.</div>
          </div>
          <div class="card" style="padding:12px">
            <div class="k">Suggested contribution / period</div>
            <div class="v" id="suggested">$0.00</div>
            <div class="note">You can change this in the simulator at any time.</div>
          </div>
        </div>

        <div class="rowx" style="margin-top:12px">
          <div class="card" style="padding:12px">
            <div class="k">After expenses (monthly)</div>
            <div class="v" id="after_exp">$0.00</div>
            <div class="note">Take-home (monthly) − expenses (monthly).</div>
          </div>
          <div class="card" style="padding:12px">
            <div class="k">Recommended initial lock</div>
            <div class="v" id="init_lock">$1,500.00</div>
            <div class="note">We’ll start your demo at this balance (editable later).</div>
          </div>
        </div>

        <div class="actions" style="margin-top:10px">
          <button class="btn acc" id="sendToSim">Use in simulator</button>
          <button class="btn" id="resetCalc">Reset</button>
          <button class="btn ghost" onclick="document.getElementById('simulator').scrollIntoView({behavior:'smooth'})">Scroll to simulator</button>
        </div>

        <p class="note" style="margin-top:10px">
          This calculator is an estimate and may not be 100% accurate. Actual withholding depends on your W-4, deductions, credits, and state rules.
        </p>
      </div>

      <!-- Snapshot (side) -->
      <aside class="card snapshot" role="complementary" aria-label="Snapshot preview">
        <h3>Your Snapshot</h3>
        <div class="balance">Projected take-home (monthly)</div>
        <div class="balance" id="monthly_takehome">$0.00</div>
        <div class="muted" style="margin:4px 0 10px">Based on your income frequency and selections.</div>

        <div class="k">Lock target progress</div>
        <div class="bar"><div id="snap_fill" class="fill" style="width:0%"></div></div>
        <div class="row" style="margin-top:6px;justify-content:space-between">
          <span class="muted">0%</span>
          <span class="muted" id="snap_pct">0%</span>
        </div>

        <div class="card" style="padding:12px;margin-top:12px">
          <div class="k">Initial lock (starting balance)</div>
          <div class="v" id="snap_init">$1,500.00</div>
        </div>
        <div class="card" style="padding:12px;margin-top:8px">
          <div class="k">Recurring contribution</div>
          <div class="v" id="snap_rec">$200.00 bi-weekly</div>
        </div>
        <p class="note" style="margin-top:10px">Click “Use in simulator” to apply these numbers below.</p>
      </aside>
    </div>
  </section>

  <!-- Simulator -->
  <section id="simulator" class="wrap" aria-labelledby="sim-title" style="padding:16px 22px 0">
    <h2 id="sim-title" style="color:#f2f4ff;margin:6px 0 10px">Savings Simulator</h2>
    <div class="bubble" aria-live="polite">
      <div class="row" style="align-items:flex-start">
        <div>
          <div class="muted">Total Locked Balance</div>
          <div class="balance-lg" id="sim_balance">$1,500.00</div>
          <div class="muted">Lock: <b id="sim_term_lbl">12 months</b> • Next deposit: <b id="sim_rec_lbl">$200</b> in <b id="sim_next">14 days</b></div>
          <div style="margin-top:8px" class="pill">3% APR • FDIC-backed custody*</div>
        </div>
        <div style="min-width:260px;max-width:340px;width:32%">
          <div class="muted">Progress</div>
          <div class="bar"><div class="fill" id="sim_fill" style="width:0%"></div></div>
          <div class="row" style="margin-top:6px;justify-content:space-between">
            <div class="muted">Year target</div>
            <div class="muted" id="sim_pct">0%</div>
          </div>
          <div class="kpi" style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px;margin-top:8px">
            <div class="card" style="padding:10px">
              <div class="k">Interest so far</div><div class="v" id="sim_int_sofar">$0.00</div>
            </div>
            <div class="card" style="padding:10px">
              <div class="k">Projected @ maturity</div><div class="v" id="sim_int_proj">$0.00</div>
            </div>
          </div>
        </div>
      </div>

      <div class="kpi" style="margin-top:10px">
        <div class="box">
          <div class="k">Loan eligibility</div>
          <div class="v" id="sim_loan_elig">$1,125.00</div>
          <div class="note">Up to <b>75%</b> of vested balance</div>
        </div>
        <div class="box">
          <div class="k">Unlock fee</div>
          <div class="v" id="sim_fee">$1.00</div>
          <div class="note">$3 / $2 / $1 based on term</div>
        </div>
        <div class="box">
          <div class="k">Mode</div>
          <div class="v"><select id="sim_mode"><option value="safe" selected>Safe (3% APR)</option><option value="risk">High-risk ETF (15% simulated)</option></select></div>
          <div class="note" id="risk_warn" style="display:none">High-risk is illustrative only. You can lose money.</div>
        </div>
        <div class="box">
          <div class="k">Change term</div>
          <div class="v"><select id="sim_term"><option value="3">3 mo</option><option value="6">6 mo</option><option value="12" selected>12 mo</option><option value="18">18 mo</option><option value="24">24 mo</option></select></div>
          <div class="note">Extending increases projected interest</div>
        </div>
      </div>

      <div class="actions">
        <button class="btn acc" id="btnLoan">Request self-loan</button>
        <button class="btn" id="btnExtend">Extend term</button>
        <button class="btn" id="btnCashout">Cash out (simulate)</button>
        <button class="btn ghost" id="btnHow">How this works</button>
      </div>
      <div class="note" style="margin-top:6px">* Demo only. Illustrative rates & terms.</div>
    </div>
  </section>

  <!-- Modal (reusable) -->
  <div id="overlay" class="overlay" aria-modal="true" role="dialog">
    <div class="modal" id="modalBox" role="document">
      <div class="row">
        <h3 id="modalTitle" style="margin:0">Modal</h3>
        <button class="x" id="modalClose" aria-label="Close">✕</button>
      </div>
      <div id="modalBody" style="margin-top:8px"></div>
    </div>
  </div>

  <!-- Footer -->
  <footer>© <span id="yr"></span> LockHabit — Demo simulation.</footer>

  <!-- Structured data (SEO) -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"WebApplication",
    "name":"LockHabit Demo",
    "url":"https://lockhabit.com/demo.html",
    "applicationCategory":"FinanceApplication",
    "description":"Estimate take-home pay and simulate disciplined saving with interest and self-backed loans."
  }
  </script>
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"FAQPage",
    "mainEntity":[
      {"@type":"Question","name":"How is take-home estimated?","acceptedAnswer":{"@type":"Answer","text":"We apply rough federal + FICA and a simple state rate for common states. Actual withholding varies by W-4, deductions, and credits."}},
      {"@type":"Question","name":"What is loan eligibility?","acceptedAnswer":{"@type":"Answer","text":"In the demo, you can borrow up to 75% of your vested balance at 6% APR, with interest credited back after payoff."}},
      {"@type":"Question","name":"Can I extend my lock?","acceptedAnswer":{"@type":"Answer","text":"Yes. Extending increases projected interest. Unlock fee is a flat $3 / $2 / $1 depending on term length."}}
    ]
  }
  </script>

  <!-- Scripts -->
  <script>
    /* Live year + sticky header behavior */
    document.getElementById('yr').textContent = new Date().getFullYear();
    (function(){
      const hdr = document.getElementById('hdr');
      let last = window.scrollY;
      window.addEventListener('scroll', ()=>{
        const y = window.scrollY;
        if(y > last && y > 60) hdr.classList.add('hide'); else hdr.classList.remove('hide');
        last = y;
      }, {passive:true});
    })();

    /* Modal helpers */
    const overlay = document.getElementById('overlay');
    const modalTitle = document.getElementById('modalTitle');
    const modalBody  = document.getElementById('modalBody');
    const modalClose = document.getElementById('modalClose');
    modalClose.addEventListener('click', closeModal);
    overlay.addEventListener('click', (e)=>{ if(e.target===overlay) closeModal(); });
    function openModal(title, html){ modalTitle.textContent = title; modalBody.innerHTML = html; overlay.style.display='flex'; document.body.style.overflow='hidden'; }
    function closeModal(){ overlay.style.display='none'; document.body.style.overflow=''; }

    /* Waitlist (reuses modal) */
    function openWaitlist(){
      openModal('Join the LockHabit waitlist', `
        <p class="note">Be first in line when invites open. We’ll only email you about LockHabit.</p>
        <form id="wl-form" class="form" novalidate>
          <input type="email" name="email" placeholder="Email address" required aria-label="Email address"/>
          <input type="text" name="name" placeholder="Name (optional)" aria-label="Name"/>
          <select name="term" aria-label="Preferred lock term">
            <option value="">Preferred lock term (optional)</option>
            <option value="1-3">1–3 months</option>
            <option value="4-6">4–6 months</option>
            <option value="6-12+">6–12+ months</option>
          </select>
          <button class="btn acc" type="submit">Join the waitlist</button>
          <div id="msg" class="note" role="status" aria-live="polite"></div>
        </form>
        <div id="ok" class="ok" style="display:none;margin-top:8px">✅ Thanks — you’re on the list!</div>
      `);
      const form = document.getElementById('wl-form');
      const msg  = document.getElementById('msg');
      const ok   = document.getElementById('ok');
      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        msg.textContent='Submitting…'; msg.style.color='#60708c';
        const data = Object.fromEntries(new FormData(form).entries());
        try{
          const r = await fetch('/api/waitlist', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data) });
          const j = await r.json().catch(()=>({}));
          if(r.ok && (j.ok || j.id || j.inserted)){ form.style.display='none'; ok.style.display='inline-block'; return; }
        }catch(_){}
        // Formspree fallback (update endpoint if different)
        try{
          const fs = await fetch('https://formspree.io/f/manpgypy', {
            method:'POST', headers:{'Accept':'application/json'}, body:new FormData(form)
          });
          if(fs.ok){ form.style.display='none'; ok.style.display='inline-block'; return; }
          msg.textContent='Network error. Please try again.'; msg.style.color='#b42318';
        }catch(_){ msg.textContent='Network error. Please try again.'; msg.style.color='#b42318'; }
      });
    }
    window.openWaitlist = openWaitlist;

    /* ===== CALCULATOR LOGIC ===== */
    const inc_freq = document.getElementById('inc_freq');
    const inc_amt  = document.getElementById('inc_amt');
    const filing   = document.getElementById('filing');
    const stateSel = document.getElementById('state');
    const taxopt   = document.getElementById('taxopt');
    const expenses = document.getElementById('expenses');
    const save_pct = document.getElementById('save_pct');
    const save_pct_lbl = document.getElementById('save_pct_lbl');

    const takehomeEl = document.getElementById('takehome');
    const suggestedEl= document.getElementById('suggested');
    const afterExpEl = document.getElementById('after_exp');
    const initLockEl = document.getElementById('init_lock');

    const monthlyTakehomeEl = document.getElementById('monthly_takehome');
    const snapFill = document.getElementById('snap_fill');
    const snapPct  = document.getElementById('snap_pct');
    const snapInit = document.getElementById('snap_init');
    const snapRec  = document.getElementById('snap_rec');

    const sendToSim = document.getElementById('sendToSim');
    const resetCalc = document.getElementById('resetCalc');

    const PERIODS = { weekly:52, biweekly:26, monthly:12, annual:1 };

    // super-simplified state rates (illustrative only)
    const STATE_RATE = {
      CA: 0.07, NY: 0.06, IL: 0.0495, PA: 0.0307, OH: 0.035, MI: 0.043,
      GA: 0.054, NC: 0.045, TX: 0, FL: 0, none: 0
    };

    function toAnnual(freq, amt){
      const p = PERIODS[freq] || 1;
      return Math.max(0, Number(amt||0)) * p;
    }
    function fromAnnual(freq, annual){
      const p = PERIODS[freq] || 1;
      return (annual / p);
    }

    function roughFederal(annual, status){
      // very rough stepped estimate (not official brackets)
      const bracket = status === 'married'
        ? [{up:22000, r:.10},{up:94000, r:.12},{up:201000, r:.22},{up:383000, r:.24},{up:1000000, r:.32},{up:Infinity, r:.35}]
        : [{up:11000, r:.10},{up:44725, r:.12},{up:95375, r:.22},{up:182100, r:.24},{up:231250, r:.32},{up:578125, r:.35},{up:Infinity, r:.37}];
      let prev = 0, tax = 0;
      for(const b of bracket){
        const cap = Math.min(annual, b.up);
        if(cap > prev){ tax += (cap - prev) * b.r; prev = cap; }
        if(annual <= b.up) break;
      }
      return tax;
    }
    function fica(annual){
      // 7.65% employee portion up to OASDI cap (ignore cap for demo)
      return annual * 0.0765;
    }

    function recalcCalc(){
      const freq = inc_freq.value;
      const amt  = Number(inc_amt.value||0);
      const status = filing.value;
      const state  = stateSel.value;
      const exempt = taxopt.value === 'exempt';
      const exp    = Math.max(0, Number(expenses.value||0));
      const pct    = Math.max(5, Math.min(25, Number(save_pct.value||15)));
      save_pct_lbl.textContent = pct + '%';

      // annualize
      const annual = toAnnual(freq, amt);

      // taxes
      let fed = 0, ssmed = 0, stax = 0;
      if(!exempt){
        fed   = roughFederal(annual, status);
        ssmed = fica(annual);
        stax  = annual * (STATE_RATE[state] || 0);
      }
      const totalTax = fed + ssmed + stax;
      const annualTake = Math.max(0, annual - totalTax);

      // per-period take-home
      const perTake = fromAnnual(freq, annualTake);
      takehomeEl.textContent = perTake.toLocaleString(undefined,{style:'currency',currency:'USD'});

      // suggested contribution per period
      const suggested = perTake * (pct/100);
      suggestedEl.textContent = suggested.toLocaleString(undefined,{style:'currency',currency:'USD'});

      // monthly take-home (normalize)
      const monthlyTake = annualTake / 12;
      monthlyTakehomeEl.textContent = monthlyTake.toLocaleString(undefined,{style:'currency',currency:'USD'});

      // after expenses (monthly)
      const after = Math.max(0, monthlyTake - exp);
      afterExpEl.textContent = after.toLocaleString(undefined,{style:'currency',currency:'USD'});

      // initial lock guess: 1 month of suggested + $500 floor
      const initial = Math.max(500, suggested * (PERIODS[freq]/12));
      initLockEl.textContent = initial.toLocaleString(undefined,{style:'currency',currency:'USD'});
      snapInit.textContent   = initLockEl.textContent;

      // snapshot progress bar: suggested% of take-home
      const pctFill = Math.min(100, Math.max(0, pct));
      snapFill.style.width = pctFill+'%';
      snapPct.textContent = pctFill.toFixed(0)+'%';

      // snapshot recurring text
      snapRec.textContent = suggested.toLocaleString(undefined,{style:'currency',currency:'USD'}) + ' ' + labelForFreq(freq);
    }
    function labelForFreq(f){ return f==='weekly'?'weekly':(f==='biweekly'?'bi-weekly':(f==='monthly'?'monthly':'annually')); }

    [inc_freq,inc_amt,filing,stateSel,taxopt,expenses,save_pct].forEach(el => el.addEventListener('input', recalcCalc));
    recalcCalc();

    // Apply to simulator
    sendToSim.addEventListener('click', ()=>{
      const freq = inc_freq.value;
      const status = filing.value;
      const suggested = parseCurrency(suggestedEl.textContent);
      const initial   = parseCurrency(initLockEl.textContent);
      // Save in localStorage and querystring (both)
      const payload = { rec: suggested, freq, init: initial, months: 12, mode: 'safe' };
      localStorage.setItem('lh_demo', JSON.stringify(payload));
      const url = new URL(location.href);
      url.searchParams.set('rec', String(suggested.toFixed(2)));
      url.searchParams.set('freq', freq);
      url.searchParams.set('init', String(initial.toFixed(2)));
      url.searchParams.set('months','12');
      history.replaceState(null,'',url.toString());
      // scroll to simulator
      document.getElementById('simulator').scrollIntoView({behavior:'smooth'});
      // hydrate simulator
      hydrateFromPayload(payload, true);
    });

    resetCalc.addEventListener('click', ()=>{
      inc_freq.value='biweekly'; inc_amt.value='2000'; filing.value='single'; stateSel.value='none';
      taxopt.value='normal'; expenses.value='1500'; save_pct.value='15'; recalcCalc();
    });

    function parseCurrency(s){ return Number((s||'').replace(/[^0-9.\-]/g,''))||0; }

    /* ===== SIMULATOR LOGIC ===== */
    const sim_balance = document.getElementById('sim_balance');
    const sim_term_lbl= document.getElementById('sim_term_lbl');
    const sim_rec_lbl = document.getElementById('sim_rec_lbl');
    const sim_next    = document.getElementById('sim_next');
    const sim_fill    = document.getElementById('sim_fill');
    const sim_pct     = document.getElementById('sim_pct');
    const sim_int_sofar = document.getElementById('sim_int_sofar');
    const sim_int_proj  = document.getElementById('sim_int_proj');
    const sim_loan_elig = document.getElementById('sim_loan_elig');
    const sim_fee     = document.getElementById('sim_fee');
    const sim_mode    = document.getElementById('sim_mode');
    const sim_term    = document.getElementById('sim_term');

    let S = {
      principal: 1500,
      months: 12,
      mode: 'safe', // safe=3% APR, risk=15% simulated
      rec: 200,     // recurring deposit per cycle
      freq: 'biweekly',
      progress: 0   // %
    };

    function feeForTerm(m){ if(m<=3) return 3; if(m<=6) return 2; return 1; }
    function aprFor(mode){ return mode==='risk' ? 0.15 : 0.03; }
    function cyclesFor(freq, months){ const weeks = months*4.345; if(freq==='weekly') return Math.floor(weeks); if(freq==='biweekly') return Math.floor(weeks/2); return months; }

    function updateSimKPIs(){
      const apr = aprFor(S.mode);
      const projInterest = S.principal * apr * (S.months/12);
      const sofar = projInterest * (S.progress/100);
      const fee = feeForTerm(S.months);
      const vested = S.principal + sofar; // demo notion of "vested"
      const loanElig = Math.max(0, vested * 0.75);

      sim_balance.textContent = fmt(S.principal);
      sim_term_lbl.textContent = S.months + ' months';
      sim_rec_lbl.textContent = fmt(S.rec);
      sim_next.textContent = S.freq==='weekly'?'7 days':'14 days';
      sim_fill.style.width = S.progress.toFixed(0) + '%';
      sim_pct.textContent = S.progress.toFixed(0) + '%';
      sim_int_sofar.textContent = fmt(sofar);
      sim_int_proj.textContent  = fmt(projInterest);
      sim_loan_elig.textContent = fmt(loanElig);
      sim_fee.textContent = fmt(fee);
      document.getElementById('risk_warn').style.display = (S.mode==='risk') ? 'block' : 'none';
      sim_mode.value = S.mode;
      sim_term.value = String(S.months);
    }
    function fmt(n){ return n.toLocaleString(undefined,{style:'currency',currency:'USD'}); }

    // Progress animation loop
    setInterval(()=>{
      S.progress = (S.progress + Math.random()*4) % 100;
      updateSimKPIs();
    }, 900);

    // Apply query/localStorage on load
    (function initFromURL(){
      const url = new URL(location.href);
      const qs = {
        init: Number(url.searchParams.get('init')||0),
        rec: Number(url.searchParams.get('rec')||0),
        freq: url.searchParams.get('freq')||'',
        months: Number(url.searchParams.get('months')||0),
        mode: url.searchParams.get('mode')||''
      };
      if(qs.init||qs.rec||qs.freq||qs.months||qs.mode){
        hydrateFromPayload({
          init: qs.init||S.principal,
          rec: qs.rec||S.rec,
          freq: qs.freq||S.freq,
          months: qs.months||S.months,
          mode: qs.mode||S.mode
        }, false);
      }else{
        const mem = localStorage.getItem('lh_demo');
        if(mem){
          try{ const obj = JSON.parse(mem); hydrateFromPayload(obj, false); }catch(_){}
        }else{
          updateSimKPIs();
        }
      }
    })();

    function hydrateFromPayload(p, flash){
      S.principal = Math.max(0, Number(p.init||S.principal));
      S.rec = Math.max(0, Number(p.rec||S.rec));
      S.freq = p.freq || S.freq;
      S.months = Math.max(1, Number(p.months||S.months));
      S.mode = p.mode || S.mode;
      S.progress = 0;
      updateSimKPIs();
      if(flash){ openModal('Applied to Simulator', `<div class="ok">✅ Numbers sent from calculator.</div>`); }
    }

    // Change handlers
    sim_mode.addEventListener('change', ()=>{ S.mode = sim_mode.value; updateSimKPIs(); });
    sim_term.addEventListener('change', ()=>{ S.months = Number(sim_term.value); updateSimKPIs(); });

    // Explain
    document.getElementById('btnHow').addEventListener('click', ()=>{
      openModal('How LockHabit Works', `
        <p>Lock your savings so they stay out of sight and grow at <b>${(aprFor('safe')*100).toFixed(0)}% APR</b> (prorated).</p>
        <p>Need funds? Borrow up to <b>75%</b> of your vested balance at <b>6% APR</b>. The interest you pay is <b>credited back to your lock</b> after payoff. Payments are intended to be <b>bureau-reported</b> (on-time helps; late can harm).</p>
        <p>At unlock, you’ll receive principal + earned interest minus a small flat fee (<b>$3 / $2 / $1</b> by term). You can extend to keep earning without paying a fee now.</p>
        <div class="note">This is a demo simulation for illustration only.</div>
      `);
    });

    // Extend term
    document.getElementById('btnExtend').addEventListener('click', ()=>{
      const preview = feeForTerm(S.months+6);
      openModal('Extend Term', `
        <p>Extend your lock to keep earning.</p>
        <div class="rowx">
          <div>
            <label class="k">Add months</label>
            <select id="extendSel">
              <option value="3">+3</option>
              <option value="6" selected>+6</option>
              <option value="12">+12</option>
            </select>
          </div>
          <div>
            <label class="k">New unlock fee</label>
            <div class="v" id="newFee">${fmt(preview)}</div>
          </div>
        </div>
        <div class="actions" style="margin-top:12px">
          <button class="btn acc" id="doExtend">Confirm extend</button>
          <button class="btn" onclick="(${closeModal.toString()})()">Cancel</button>
        </div>
        <div class="note">Extending avoids any fee now; fee applies at the new maturity.</div>
      `);
      const sel = document.getElementById('extendSel');
      const feeEl = document.getElementById('newFee');
      sel.addEventListener('change', ()=> feeEl.textContent = fmt(feeForTerm(S.months+Number(sel.value))));
      document.getElementById('doExtend').addEventListener('click', ()=>{
        S.months += Number(sel.value);
        updateSimKPIs();
        closeModal();
        setTimeout(()=>openModal('Extended', `<div class="ok">✅ New term: <b>${S.months} months</b>.</div>`), 80);
      });
    });

    // Loan request (eligibility 75% of vested)
    document.getElementById('btnLoan').addEventListener('click', ()=>{
      const aprLoan = 0.06;
      const apr = aprFor(S.mode);
      const vested = S.principal + (S.principal*apr*(S.months/12))*(S.progress/100);
      const max = Math.floor(vested * 0.75);
      const def = Math.min(500, max);
      openModal('Request a Self-Backed Loan', `
        <p>Borrow up to <b>75%</b> of vested balance at <b>6% APR</b>. Interest you pay is <b>credited back</b> to your locked balance after payoff.</p>
        <label class="k">Loan amount: <span id="loanAmtVal">${fmt(def)}</span></label>
        <input id="loanAmt" type="range" min="100" max="${Math.max(100,max)}" step="50" value="${def}"/>
        <div class="rowx" style="margin-top:8px">
          <div>
            <label class="k">Repayment term</label>
            <select id="loanTerm">
              <option value="3" selected>3 months</option>
              <option value="6">6 months</option>
              <option value="12">12 months</option>
            </select>
          </div>
          <div>
            <label class="k">Monthly payment</label>
            <div class="v" id="loanPmt">$0.00</div>
          </div>
        </div>
        <div class="rowx" style="margin-top:10px">
          <div class="card" style="padding:10px">
            <div class="k">Total repay</div><div class="v" id="loanTotal">$0.00</div>
          </div>
          <div class="card" style="padding:10px">
            <div class="k">Interest (back to you)</div><div class="v" id="loanIntBack">$0.00</div>
          </div>
        </div>
        <div class="note" style="margin-top:8px">On-time payments may help your credit; late payments may harm it. Demo only.</div>
        <div class="actions" style="margin-top:12px">
          <button class="btn acc" id="doLoan">Request loan</button>
          <button class="btn" onclick="(${closeModal.toString()})()">Cancel</button>
        </div>
      `);
      const amt = document.getElementById('loanAmt');
      const amtVal = document.getElementById('loanAmtVal');
      const termSel = document.getElementById('loanTerm');
      const pmtEl = document.getElementById('loanPmt');
      const totalEl = document.getElementById('loanTotal');
      const intBackEl = document.getElementById('loanIntBack');

      function recalc(){
        const A = Number(amt.value);
        const m = Number(termSel.value);
        const interest = A * aprLoan * (m/12); // simple demo
        const total = A + interest;
        const monthly = total / m;
        amtVal.textContent = fmt(A);
        pmtEl.textContent = fmt(monthly);
        totalEl.textContent = fmt(total);
        intBackEl.textContent = fmt(interest);
      }
      amt.addEventListener('input', recalc);
      termSel.addEventListener('change', recalc);
      recalc();

      document.getElementById('doLoan').addEventListener('click', ()=>{
        closeModal();
        setTimeout(()=>openModal('Loan Simulated', `
          <div class="ok">✅ Funds released to you (demo).</div>
          <p>Loan interest will be credited back to your locked balance after payoff.</p>
          <div style="text-align:right"><button class="btn acc" onclick="(${closeModal.toString()})()">Close</button></div>
        `), 100);
      });
    });

    // Cash out
    document.getElementById('btnCashout').addEventListener('click', ()=>{
      const apr = aprFor(S.mode);
      const fee = feeForTerm(S.months);
      const projInterest = S.principal * apr * (S.months/12);
      const gross = S.principal + projInterest;
      const net = gross - fee;
      openModal('Cash out (simulation)', `
        <div class="rowx">
          <div class="card" style="padding:10px"><div class="k">Principal</div><div class="v">${fmt(S.principal)}</div></div>
          <div class="card" style="padding:10px"><div class="k">Interest earned</div><div class="v">${fmt(projInterest)}</div></div>
          <div class="card" style="padding:10px"><div class="k">Unlock fee</div><div class="v">-${fmt(fee)}</div></div>
          <div class="card" style="padding:10px"><div class="k">Net to you</div><div class="v">${fmt(net)}</div></div>
        </div>
        <div class="actions" style="margin-top:12px">
          <button class="btn acc" id="doRelock">Relock & keep earning</button>
          <button class="btn" onclick="(${closeModal.toString()})()">Close</button>
        </div>
        <div class="note">In production you would choose a destination account. Demo only.</div>
      `);
      document.getElementById('doRelock').addEventListener('click', ()=>{
        S.months = 12; S.progress = 0; updateSimKPIs(); closeModal();
        setTimeout(()=>openModal('Relocked', `<div class="ok">✅ Balance relocked for another 12 months.</div>`), 80);
      });
    });

  </script>
</body>
</html>